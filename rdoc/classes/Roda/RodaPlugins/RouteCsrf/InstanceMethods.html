<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Roda::RodaPlugins::RouteCsrf::InstanceMethods</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Roda::RodaPlugins::RouteCsrf::InstanceMethods
</h1>
<ol class='paths'>
<li>
<a href="../../../../files/lib/roda/plugins/route_csrf_rb.html">lib/roda/plugins/route_csrf.rb</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'></div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Instance</h3>
<ol>
<li><a href="#method-i-check_csrf-21">check_csrf!</a></li>
<li><a href="#method-i-csrf_field">csrf_field</a></li>
<li><a href="#method-i-csrf_header">csrf_header</a></li>
<li><a href="#method-i-csrf_metatag">csrf_metatag</a></li>
<li><a href="#method-i-csrf_path">csrf_path</a></li>
<li><a href="#method-i-csrf_tag">csrf_tag</a></li>
<li><a href="#method-i-csrf_token">csrf_token</a></li>
<li><a href="#method-i-use_request_specific_csrf_tokens-3F">use_request_specific_csrf_tokens?</a></li>
<li><a href="#method-i-valid_csrf-3F">valid_csrf?</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Instance methods</h2>
<div class='method public-instance' id='method-method-i-check_csrf-21'>
<a name='method-i-check_csrf-21'></a>
<div class='synopsis'>
<span class='name'>check_csrf!</span><span class='arguments'>(opts=OPTS, &block)</span>

</div>
<div class='description'>

<p>Check that the submitted CSRF token is valid, if the request requires a CSRF token. If the CSRF token is valid or the request does not require a CSRF token, return nil. Otherwise, if a block is given, treat it as a routing block and yield to it, and if a block is not given, use the :csrf_failure option to determine how to handle it.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-check_csrf-21-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-check_csrf-21-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">188</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">check_csrf!</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">189</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">msg</span> = <span class="ruby-identifier">csrf_invalid_message</span>(<span class="ruby-identifier">opts</span>)
<span class="line-num">190</span>     <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
<span class="line-num">191</span>       <span class="ruby-ivar">@_request</span>.<span class="ruby-identifier">on</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num">192</span>     <span class="ruby-keyword">end</span>
<span class="line-num">193</span>     
<span class="line-num">194</span>     <span class="ruby-keyword">case</span> <span class="ruby-identifier">failure_action</span> = <span class="ruby-identifier">opts</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-value">:csrf_failure</span>, <span class="ruby-identifier">csrf_options</span>[<span class="ruby-value">:csrf_failure</span>])
<span class="line-num">195</span>     <span class="ruby-keyword">when</span> <span class="ruby-value">:raise</span>
<span class="line-num">196</span>       <span class="ruby-identifier">raise</span> <span class="ruby-constant">InvalidToken</span>, <span class="ruby-identifier">msg</span>
<span class="line-num">197</span>     <span class="ruby-keyword">when</span> <span class="ruby-value">:empty_403</span>
<span class="line-num">198</span>       <span class="ruby-ivar">@_response</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">403</span>
<span class="line-num">199</span>       <span class="ruby-identifier">headers</span> = <span class="ruby-ivar">@_response</span>.<span class="ruby-identifier">headers</span>
<span class="line-num">200</span>       <span class="ruby-identifier">headers</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">201</span>       <span class="ruby-identifier">headers</span>[<span class="ruby-constant">RodaResponseHeaders</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_TYPE</span>] = <span class="ruby-string">&#39;text/html&#39;</span>
<span class="line-num">202</span>       <span class="ruby-identifier">headers</span>[<span class="ruby-constant">RodaResponseHeaders</span><span class="ruby-operator">::</span><span class="ruby-constant">CONTENT_LENGTH</span>] =<span class="ruby-string">&#39;0&#39;</span>
<span class="line-num">203</span>       <span class="ruby-identifier">throw</span> <span class="ruby-value">:halt</span>, <span class="ruby-ivar">@_response</span>.<span class="ruby-identifier">finish_with_body</span>([])
<span class="line-num">204</span>     <span class="ruby-keyword">when</span> <span class="ruby-value">:clear_session</span>
<span class="line-num">205</span>       <span class="ruby-identifier">session</span>.<span class="ruby-identifier">clear</span>
<span class="line-num">206</span>     <span class="ruby-keyword">when</span> <span class="ruby-value">:csrf_failure_method</span>
<span class="line-num">207</span>       <span class="ruby-ivar">@_request</span>.<span class="ruby-identifier">on</span>{<span class="ruby-identifier">_roda_route_csrf_failure</span>(<span class="ruby-ivar">@_request</span>)}
<span class="line-num">208</span>     <span class="ruby-keyword">when</span> <span class="ruby-constant">Proc</span>
<span class="line-num">209</span>       <span class="ruby-constant">RodaPlugins</span>.<span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;Passing a Proc as the :csrf_failure option value to check_csrf! is deprecated&quot;</span>
<span class="line-num">210</span>       <span class="ruby-ivar">@_request</span>.<span class="ruby-identifier">on</span>{<span class="ruby-identifier">instance_exec</span>(<span class="ruby-ivar">@_request</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">failure_action</span>)} <span class="ruby-comment"># Deprecated</span>
<span class="line-num">211</span>     <span class="ruby-keyword">else</span>
<span class="line-num">212</span>       <span class="ruby-identifier">raise</span> <span class="ruby-constant">RodaError</span>, <span class="ruby-node">&quot;Unsupported :csrf_failure option: #{failure_action.inspect}&quot;</span>
<span class="line-num">213</span>     <span class="ruby-keyword">end</span>
<span class="line-num">214</span>   <span class="ruby-keyword">end</span>
<span class="line-num">215</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-csrf_field'>
<a name='method-i-csrf_field'></a>
<div class='synopsis'>
<span class='name'>csrf_field</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>The name of the hidden input tag containing the CSRF token.  Also used as the name for the meta tag.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-csrf_field-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-csrf_field-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">219</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_field</span>
<span class="line-num">220</span>   <span class="ruby-identifier">csrf_options</span>[<span class="ruby-value">:field</span>]
<span class="line-num">221</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-csrf_header'>
<a name='method-i-csrf_header'></a>
<div class='synopsis'>
<span class='name'>csrf_header</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>The HTTP header name to use when submitting CSRF tokens in an HTTP header, if such support is enabled (it is not by default).</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-csrf_header-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-csrf_header-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">225</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_header</span>
<span class="line-num">226</span>   <span class="ruby-identifier">csrf_options</span>[<span class="ruby-value">:header</span>]
<span class="line-num">227</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-csrf_metatag'>
<a name='method-i-csrf_metatag'></a>
<div class='synopsis'>
<span class='name'>csrf_metatag</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>An HTML meta tag string containing a CSRF token that is not request-specific. It is not recommended to use this, as it doesn’t support request-specific tokens.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-csrf_metatag-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-csrf_metatag-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">231</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_metatag</span>
<span class="line-num">232</span>   <span class="ruby-node">&quot;&lt;meta name=\&quot;#{csrf_field}\&quot; content=\&quot;#{csrf_token}\&quot; \/&gt;&quot;</span>
<span class="line-num">233</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-csrf_path'>
<a name='method-i-csrf_path'></a>
<div class='synopsis'>
<span class='name'>csrf_path</span><span class='arguments'>(action)</span>

</div>
<div class='description'>

<p>Given a form action, return the appropriate path to use for the CSRF token. This makes it easier to generate request-specific tokens without having to worry about the different types of form actions (relative paths, absolute paths, URLs, empty paths).</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-csrf_path-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-csrf_path-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">239</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_path</span>(<span class="ruby-identifier">action</span>)
<span class="line-num">240</span>   <span class="ruby-keyword">case</span> <span class="ruby-identifier">action</span>
<span class="line-num">241</span>   <span class="ruby-keyword">when</span> <span class="ruby-keyword">nil</span>, <span class="ruby-string">&#39;&#39;</span>, <span class="ruby-regexp">/\A[#?]/</span>
<span class="line-num">242</span>     <span class="ruby-comment"># use current path</span>
<span class="line-num">243</span>     <span class="ruby-identifier">request</span>.<span class="ruby-identifier">path</span>
<span class="line-num">244</span>   <span class="ruby-keyword">when</span> <span class="ruby-regexp">/\A(?:https?:\/)?\//</span>
<span class="line-num">245</span>     <span class="ruby-comment"># Either full URI or absolute path, extract just the path</span>
<span class="line-num">246</span>     <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">action</span>).<span class="ruby-identifier">path</span>
<span class="line-num">247</span>   <span class="ruby-keyword">else</span>
<span class="line-num">248</span>     <span class="ruby-comment"># relative path, join to current path</span>
<span class="line-num">249</span>     <span class="ruby-constant">URI</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">request</span>.<span class="ruby-identifier">url</span>, <span class="ruby-identifier">action</span>).<span class="ruby-identifier">path</span>
<span class="line-num">250</span>   <span class="ruby-keyword">end</span>
<span class="line-num">251</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-csrf_tag'>
<a name='method-i-csrf_tag'></a>
<div class='synopsis'>
<span class='name'>csrf_tag</span><span class='arguments'>(*args)</span>

</div>
<div class='description'>

<p>An HTML hidden input tag string containing the CSRF token.  See <a href="InstanceMethods.html#method-i-csrf_token"><code>csrf_token</code></a> for arguments.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-csrf_tag-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-csrf_tag-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">255</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_tag</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
<span class="line-num">256</span>   <span class="ruby-node">&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;#{csrf_field}\&quot; value=\&quot;#{csrf_token(*args)}\&quot; \/&gt;&quot;</span>
<span class="line-num">257</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-csrf_token'>
<a name='method-i-csrf_token'></a>
<div class='synopsis'>
<span class='name'>csrf_token</span><span class='arguments'>(path=nil, method=('POST' if path))</span>

</div>
<div class='description'>

<p>The value of the csrf token.  For a path specific token, provide a path argument.  By default, it a path is provided, the POST request method will be assumed.  To generate a token for a non-POST request method, pass the method as the second argument.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-csrf_token-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-csrf_token-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">263</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">csrf_token</span>(<span class="ruby-identifier">path</span>=<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">method</span>=(<span class="ruby-string">&#39;POST&#39;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">path</span>))
<span class="line-num">264</span>   <span class="ruby-identifier">token</span> = <span class="ruby-constant">SecureRandom</span>.<span class="ruby-identifier">random_bytes</span>(<span class="ruby-value">31</span>)
<span class="line-num">265</span>   <span class="ruby-identifier">token</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">csrf_hmac</span>(<span class="ruby-identifier">token</span>, <span class="ruby-identifier">method</span>, <span class="ruby-identifier">path</span>)
<span class="line-num">266</span>   [<span class="ruby-identifier">token</span>].<span class="ruby-identifier">pack</span>(<span class="ruby-string">&quot;m0&quot;</span>)
<span class="line-num">267</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-use_request_specific_csrf_tokens-3F'>
<a name='method-i-use_request_specific_csrf_tokens-3F'></a>
<div class='synopsis'>
<span class='name'>use_request_specific_csrf_tokens?</span><span class='arguments'>()</span>

</div>
<div class='description'>

<p>Whether request-specific CSRF tokens should be used by default.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-use_request_specific_csrf_tokens-3F-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-use_request_specific_csrf_tokens-3F-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">270</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">use_request_specific_csrf_tokens?</span>
<span class="line-num">271</span>   <span class="ruby-identifier">csrf_options</span>[<span class="ruby-value">:require_request_specific_tokens</span>]
<span class="line-num">272</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
<div class='method public-instance' id='method-method-i-valid_csrf-3F'>
<a name='method-i-valid_csrf-3F'></a>
<div class='synopsis'>
<span class='name'>valid_csrf?</span><span class='arguments'>(opts=OPTS)</span>

</div>
<div class='description'>

<p>Whether the submitted CSRF token is valid for the request.  True if the request does not require a CSRF token.</p>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-i-valid_csrf-3F-source&#39;); return false'>
[show source]
</a>
<pre id='method-i-valid_csrf-3F-source'>    <span class="ruby-comment"># File lib/roda/plugins/route_csrf.rb</span>
<span class="line-num">276</span> <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">valid_csrf?</span>(<span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>)
<span class="line-num">277</span>   <span class="ruby-identifier">csrf_invalid_message</span>(<span class="ruby-identifier">opts</span>).<span class="ruby-identifier">nil?</span>
<span class="line-num">278</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
