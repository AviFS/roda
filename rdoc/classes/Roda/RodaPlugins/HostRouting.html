<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>Roda::RodaPlugins::HostRouting</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='class' id='wrapper'>
<div class='header'>
<h1 class='name'><span class='type'>module</span>
Roda::RodaPlugins::HostRouting
</h1>
<ol class='paths'>
<li>
<a href="../../../files/lib/roda/plugins/host_routing_rb.html">lib/roda/plugins/host_routing.rb</a>
</li>
</ol>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>The host_routing plugin adds support for more routing requests based on the requested host.  It also adds predicate methods for checking whether a request was requested with the given host.</p>

<p>When loading the plugin, you pass a block, which is used for configuring the plugin.  For example, if you want to treat requests to api.example.com or api2.example.com as api requests, and treat other requests as www requests, you could use:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:host_routing</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hosts</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">to</span> <span class="ruby-value">:api</span>, <span class="ruby-string">&quot;api.example.com&quot;</span>, <span class="ruby-string">&quot;api2.example.com&quot;</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">default</span> <span class="ruby-value">:www</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With this configuration, in your routing tree, you can call the <code>r.api</code> and <code>r.www</code> methods for dispatching to routing blocks only for those types of requests:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">api</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># requests to api.example.com or api2.example.com</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">r</span>.<span class="ruby-identifier">www</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># requests to other domains</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>In addition to the routing methods, predicate methods are also added to the request object:</p>

<pre class="ruby"><span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-node">&quot;#{r.api?}-#{r.www?}&quot;</span>
<span class="ruby-keyword">end</span>
<span class="ruby-comment"># Requests to api.example.com or api2.example.com return &quot;true-false&quot;</span>
<span class="ruby-comment"># Other requests return &quot;false-true&quot;</span>
</pre>

<p>If the <code>:scope_predicates</code> plugin option is given, predicate methods are also created in route block scope:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:host_routing</span>, <span class="ruby-value">scope_predicates:</span> <span class="ruby-keyword">true</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hosts</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">to</span> <span class="ruby-value">:api</span>, <span class="ruby-string">&quot;api.example.com&quot;</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">default</span> <span class="ruby-value">:www</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">route</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">r</span><span class="ruby-operator">|</span>
  <span class="ruby-node">&quot;#{api?}-#{www?}&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>To handle hosts that match a certain format (such as all subdomains), where the specific host names are not known up front, you can provide a block when calling <code>hosts.default</code>. This block is passed the host name, or an empty string if no host name is provided, and is evaluated in route block scope. When using this support, you should also call <code>hosts.register</code> to register host types that could be returned by the block.  For example, to handle api subdomains differently:</p>

<pre class="ruby"><span class="ruby-identifier">plugin</span> <span class="ruby-value">:host_routing</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">hosts</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">to</span> <span class="ruby-value">:api</span>, <span class="ruby-string">&quot;api.example.com&quot;</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">register</span> <span class="ruby-value">:api_sub</span>
  <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">default</span> <span class="ruby-value">:www</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">host</span><span class="ruby-operator">|</span>
    <span class="ruby-value">:api_sub</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">host</span>.<span class="ruby-identifier">end_with?</span>(<span class="ruby-string">&quot;.api.example.com&quot;</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This plugin uses the host method on the request to get the hostname (this method is defined by Rack).</p>
</div>
<div id='method-list'>
<h2>Methods</h2>
<h3>Public Class</h3>
<ol>
<li><a href="#method-c-configure">configure</a></li>
</ol>
</div>
<div id='context'>
</div>
<div id='class-list'>
<h2>Classes and Modules</h2>
<ol>
<li><a href="HostRouting/InstanceMethods.html">Roda::RodaPlugins::HostRouting::InstanceMethods</a></li>
<li><a href="HostRouting/RequestMethods.html">Roda::RodaPlugins::HostRouting::RequestMethods</a></li>
<li><a href="HostRouting/DSL.html">Roda::RodaPlugins::HostRouting::DSL</a></li>
</ol>
</div>
<div id='section'>
<div id='methods'>
<h2>Public Class methods</h2>
<div class='method public-class' id='method-method-c-configure'>
<a name='method-c-configure'></a>
<div class='synopsis'>
<span class='name'>configure</span><span class='arguments'>(app, opts=OPTS, &block)</span>

</div>
<div class='description'>

<p>Setup the host routing support.  The block yields an object used to configure the plugin.  Options:</p>
<table class="rdoc-list note-list"><tbody><tr><td class='label'>:scope_predicates </td><td>
<p>Setup predicate methods in route block scope in addition to request scope.</p>
</td></tr></tbody></table>

</div>
<div class='source'>
<a class='source-toggle' href='#' onclick='toggleCode(&#39;method-c-configure-source&#39;); return false'>
[show source]
</a>
<pre id='method-c-configure-source'>    <span class="ruby-comment"># File lib/roda/plugins/host_routing.rb</span>
<span class="line-num"> 79</span> <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier ruby-title">configure</span>(<span class="ruby-identifier">app</span>, <span class="ruby-identifier">opts</span>=<span class="ruby-constant">OPTS</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num"> 80</span>   <span class="ruby-identifier">hosts</span>, <span class="ruby-identifier">host_hash</span>, <span class="ruby-identifier">default_block</span>, <span class="ruby-identifier">default_host</span> = <span class="ruby-constant">DSL</span>.<span class="ruby-identifier">new</span>.<span class="ruby-identifier">process</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
<span class="line-num"> 81</span>   <span class="ruby-identifier">app</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:host_routing_hash</span>] = <span class="ruby-identifier">host_hash</span>
<span class="line-num"> 82</span>   <span class="ruby-identifier">app</span>.<span class="ruby-identifier">opts</span>[<span class="ruby-value">:host_routing_default_host</span>] = <span class="ruby-identifier">default_host</span>
<span class="line-num"> 83</span> 
<span class="line-num"> 84</span>   <span class="ruby-identifier">app</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:define_method</span>, <span class="ruby-value">:_host_routing_default</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">default_block</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">default_block</span>
<span class="line-num"> 85</span> 
<span class="line-num"> 86</span>   <span class="ruby-identifier">app</span><span class="ruby-operator">::</span><span class="ruby-constant">RodaRequest</span>.<span class="ruby-identifier">class_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num"> 87</span>     <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">host</span><span class="ruby-operator">|</span>
<span class="line-num"> 88</span>       <span class="ruby-identifier">host_sym</span> = <span class="ruby-identifier">host</span>.<span class="ruby-identifier">to_sym</span>
<span class="line-num"> 89</span>       <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">host_sym</span>){<span class="ruby-operator">|</span><span class="ruby-operator">&amp;</span><span class="ruby-identifier">blk</span><span class="ruby-operator">|</span> <span class="ruby-identifier">always</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">blk</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">_host_routing_host</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">host</span>}
<span class="line-num"> 90</span>       <span class="ruby-identifier">alias_method</span> <span class="ruby-identifier">host_sym</span>, <span class="ruby-identifier">host_sym</span>
<span class="line-num"> 91</span> 
<span class="line-num"> 92</span>       <span class="ruby-identifier">meth</span> = <span class="ruby-value">:&quot;#{host}?&quot;</span>
<span class="line-num"> 93</span>       <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">meth</span>){<span class="ruby-identifier">_host_routing_host</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">host</span>}
<span class="line-num"> 94</span>       <span class="ruby-identifier">alias_method</span> <span class="ruby-identifier">meth</span>, <span class="ruby-identifier">meth</span>
<span class="line-num"> 95</span>     <span class="ruby-keyword">end</span>
<span class="line-num"> 96</span>   <span class="ruby-keyword">end</span>
<span class="line-num"> 97</span> 
<span class="line-num"> 98</span>   <span class="ruby-keyword">if</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value">:scope_predicates</span>]
<span class="line-num"> 99</span>     <span class="ruby-identifier">app</span>.<span class="ruby-identifier">class_exec</span> <span class="ruby-keyword">do</span>
<span class="line-num">100</span>       <span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">host</span><span class="ruby-operator">|</span>
<span class="line-num">101</span>         <span class="ruby-identifier">meth</span> = <span class="ruby-value">:&quot;#{host}?&quot;</span>
<span class="line-num">102</span>         <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">meth</span>){<span class="ruby-ivar">@_request</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">meth</span>)}
<span class="line-num">103</span>         <span class="ruby-identifier">alias_method</span> <span class="ruby-identifier">meth</span>, <span class="ruby-identifier">meth</span>
<span class="line-num">104</span>       <span class="ruby-keyword">end</span>
<span class="line-num">105</span>     <span class="ruby-keyword">end</span>
<span class="line-num">106</span>   <span class="ruby-keyword">end</span>
<span class="line-num">107</span> <span class="ruby-keyword">end</span></pre>
</div>
</div>
</div>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna"><strong>Hanna</strong> RDoc template</a>
</div>
</body>
</html>
